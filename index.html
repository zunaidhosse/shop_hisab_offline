<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Hisab (Offline)</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            font-family: 'Noto Sans Bengali', sans-serif;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
    </style>
</head>
<body class="bg-blue-50 min-h-screen">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-lg sticky top-0 z-10">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <button id="backBtn" class="mr-2 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h1 class="text-xl font-bold">Shop Hisab (Offline)</h1>
            </div>
            <button id="infoBtn" class="bg-blue-700 rounded-full p-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 pb-20">
        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page active">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="glass-card rounded-xl p-4 shadow-lg text-center">
                    <div class="text-blue-600 text-lg">üí∞ ‡¶Æ‡ßã‡¶ü ‡¶Ü‡ßü</div>
                    <div class="text-2xl font-bold" id="totalIncome">SAR 0</div>
                </div>
                <div class="glass-card rounded-xl p-4 shadow-lg text-center">
                    <div class="text-blue-600 text-lg">üí∏ ‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö</div>
                    <div class="text-2xl font-bold" id="totalExpense">SAR 0</div>
                </div>
                <div class="glass-card rounded-xl p-4 shadow-lg text-center">
                    <div class="text-blue-600 text-lg">üè¶ ‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</div>
                    <div class="text-2xl font-bold" id="totalBalance">SAR 0</div>
                </div>
            </div>

            <h2 class="text-xl font-semibold mb-4">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶Æ‡ßÇ‡¶π</h2>
            <div id="categoriesList" class="space-y-4">
                <!-- Categories will be loaded here -->
            </div>
        </div>

        <!-- Sub-Categories Page -->
        <div id="subCategoriesPage" class="page">
            <h2 id="subCategoryPageTitle" class="text-xl font-semibold mb-4"></h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="glass-card rounded-xl p-4 shadow-lg text-center">
                    <div class="text-blue-600 text-lg">‡¶Æ‡ßã‡¶ü ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</div>
                    <div class="text-xl font-bold" id="totalTransactions">0</div>
                </div>
                <div class="glass-card rounded-xl p-4 shadow-lg text-center">
                    <div class="text-blue-600 text-lg">‡¶Æ‡ßã‡¶ü ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</div>
                    <div class="text-xl font-bold" id="totalAmount">SAR 0</div>
                </div>
            </div>

            <h3 class="text-lg font-medium mb-4">‡¶∏‡¶æ‡¶¨-‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶Æ‡ßÇ‡¶π</h3>
            <div id="subCategoriesList" class="space-y-4">
                <!-- Sub-categories will be loaded here -->
            </div>
        </div>

        <!-- Transactions Page -->
        <div id="transactionsPage" class="page">
            <h2 id="transactionPageTitle" class="text-xl font-semibold mb-4"></h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="glass-card rounded-xl p-4 shadow-lg text-center">
                    <div class="text-blue-600 text-lg">‡¶Æ‡ßã‡¶ü ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</div>
                    <div class="text-xl font-bold" id="transactionsCount">0</div>
                </div>
                <div class="glass-card rounded-xl p-4 shadow-lg text-center">
                    <div class="text-blue-600 text-lg">‡¶Æ‡ßã‡¶ü ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</div>
                    <div class="text-xl font-bold" id="transactionsAmount">SAR 0</div>
                </div>
            </div>

            <h3 class="text-lg font-medium mb-4">‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶∏‡¶Æ‡ßÇ‡¶π</h3>
            <div id="transactionsList" class="space-y-4">
                <!-- Transactions will be loaded here -->
            </div>
        </div>
    </main>

    <!-- Floating Action Button -->
    <button id="fab" class="fixed bottom-6 right-6 bg-blue-600 text-white rounded-full p-4 shadow-lg hover:bg-blue-700 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
    </button>

    <!-- PWA Install Prompt -->
    <div id="installPrompt" class="fixed bottom-0 left-0 right-0 bg-blue-600 text-white p-4 shadow-lg hidden">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <span class="mr-2">üì±</span>
                <span>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶∏ ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®</span>
            </div>
            <div>
                <button id="installCancel" class="bg-blue-500 px-3 py-1 rounded mr-2">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                <button id="installBtn" class="bg-white text-blue-600 px-3 py-1 rounded">‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Category Modal -->
    <div id="addCategoryModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
        <div class="glass-card rounded-xl p-6 w-full max-w-md mx-4 fade-in">
            <h3 class="text-xl font-semibold mb-4">‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
            <form id="addCategoryForm">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">‡¶®‡¶æ‡¶Æ</label>
                    <input type="text" id="categoryName" class="w-full p-2 border border-gray-300 rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">‡¶ß‡¶∞‡¶®</label>
                    <select id="categoryType" class="w-full p-2 border border-gray-300 rounded">
                        <option value="income">‡¶Ü‡ßü</option>
                        <option value="expense">‡¶ñ‡¶∞‡¶ö</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelCategory" class="bg-gray-300 px-4 py-2 rounded">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Sub-Category Modal -->
    <div id="addSubCategoryModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
        <div class="glass-card rounded-xl p-6 w-full max-w-md mx-4 fade-in">
            <h3 class="text-xl font-semibold mb-4">‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶æ‡¶¨-‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
            <form id="addSubCategoryForm">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">‡¶®‡¶æ‡¶Æ</label>
                    <input type="text" id="subCategoryName" class="w-full p-2 border border-gray-300 rounded" required>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelSubCategory" class="bg-gray-300 px-4 py-2 rounded">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div id="addTransactionModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
        <div class="glass-card rounded-xl p-6 w-full max-w-md mx-4 fade-in">
            <h3 class="text-xl font-semibold mb-4">‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
            <form id="addTransactionForm">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (SAR)</label>
                    <input type="number" step="0.01" id="transactionAmount" class="w-full p-2 border border-gray-300 rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                    <input type="date" id="transactionDate" class="w-full p-2 border border-gray-300 rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</label>
                    <textarea id="transactionDescription" class="w-full p-2 border border-gray-300 rounded"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelTransaction" class="bg-gray-300 px-4 py-2 rounded">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editTransactionModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
        <div class="glass-card rounded-xl p-6 w-full max-w-md mx-4 fade-in">
            <h3 class="text-xl font-semibold mb-4">‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
            <form id="editTransactionForm">
                <input type="hidden" id="editTransactionId">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (SAR)</label>
                    <input type="number" step="0.01" id="editTransactionAmount" class="w-full p-2 border border-gray-300 rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                    <input type="date" id="editTransactionDate" class="w-full p-2 border border-gray-300 rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</label>
                    <textarea id="editTransactionDescription" class="w-full p-2 border border-gray-300 rounded"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelEditTransaction" class="bg-gray-300 px-4 py-2 rounded">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
        <div class="glass-card rounded-xl p-6 w-full max-w-md mx-4 fade-in">
            <h3 class="text-xl font-semibold mb-4" id="confirmTitle">‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
            <p id="confirmMessage" class="mb-6">‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?</p>
            <div class="flex justify-end space-x-2">
                <button id="confirmCancel" class="bg-gray-300 px-4 py-2 rounded">‡¶®‡¶æ</button>
                <button id="confirmOk" class="bg-red-600 text-white px-4 py-2 rounded">‡¶π‡ßç‡¶Ø‡¶æ‡¶Å</button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
        <div class="glass-card rounded-xl p-6 w-full max-w-md mx-4 fade-in">
            <h3 class="text-xl font-semibold mb-4">‡¶§‡¶•‡ßç‡¶Ø</h3>
            <div class="space-y-3">
                <button id="helpLineBtn" class="w-full text-left p-3 bg-blue-100 rounded-lg hover:bg-blue-200 transition">
                    ‡¶π‡ßá‡¶≤‡ßç‡¶™ ‡¶≤‡¶æ‡¶á‡¶®
                </button>
                <button id="shareAppBtn" class="w-full text-left p-3 bg-blue-100 rounded-lg hover:bg-blue-200 transition">
                    ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶∏ ‡¶∂‡ßá‡ßü‡¶æ‡¶∞
                </button>
            </div>
            <div class="flex justify-end mt-4">
                <button id="closeInfoModal" class="bg-gray-300 px-4 py-2 rounded">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
        <div class="glass-card rounded-xl p-6 w-full max-w-md mx-4 fade-in text-center">
            <h3 class="text-xl font-semibold mb-4">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶∏ ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
            <div id="qrCodeContainer" class="mb-4">
                <!-- QR Code will be loaded here -->
            </div>
            <div class="flex justify-center">
                <button id="closeQrModal" class="bg-gray-300 px-4 py-2 rounded">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <script>
        // PWA Installation
        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');
        const installBtn = document.getElementById('installBtn');
        const installCancel = document.getElementById('installCancel');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installPrompt.classList.remove('hidden');
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    installPrompt.classList.add('hidden');
                }
                deferredPrompt = null;
            }
        });

        installCancel.addEventListener('click', () => {
            installPrompt.classList.add('hidden');
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Data Management
        const STORAGE_KEYS = {
            CATEGORIES: 'shop_hisab_categories',
            SUB_CATEGORIES: 'shop_hisab_sub_categories',
            TRANSACTIONS: 'shop_hisab_transactions'
        };

        function getData(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }

        function saveData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        function generateId() {
            return Date.now().toString();
        }

        // Navigation
        const pages = {
            dashboard: document.getElementById('dashboardPage'),
            subCategories: document.getElementById('subCategoriesPage'),
            transactions: document.getElementById('transactionsPage')
        };

        const backBtn = document.getElementById('backBtn');
        let currentPage = 'dashboard';
        let currentCategoryId = null;
        let currentSubCategoryId = null;

        function showPage(pageName) {
            Object.values(pages).forEach(page => page.classList.remove('active'));
            pages[pageName].classList.add('active');
            
            if (pageName === 'dashboard') {
                backBtn.classList.add('hidden');
                currentPage = 'dashboard';
                renderDashboard();
            } else if (pageName === 'subCategories') {
                backBtn.classList.remove('hidden');
                currentPage = 'subCategories';
                renderSubCategoriesPage();
            } else if (pageName === 'transactions') {
                backBtn.classList.remove('hidden');
                currentPage = 'transactions';
                renderTransactionsPage();
            }
        }

        backBtn.addEventListener('click', () => {
            if (currentPage === 'subCategories') {
                showPage('dashboard');
            } else if (currentPage === 'transactions') {
                showPage('subCategories');
            }
        });

        // Dashboard Rendering
        function renderDashboard() {
            const categories = getData(STORAGE_KEYS.CATEGORIES);
            const transactions = getData(STORAGE_KEYS.TRANSACTIONS);
            const subCategories = getData(STORAGE_KEYS.SUB_CATEGORIES);
            
            // Calculate totals
            let totalIncome = 0;
            let totalExpense = 0;
            
            categories.forEach(category => {
                const categorySubCategories = subCategories.filter(sc => sc.categoryId === category.id);
                let categoryTotal = 0;
                
                categorySubCategories.forEach(subCategory => {
                    const subTransactions = transactions.filter(t => t.subCategoryId === subCategory.id);
                    subTransactions.forEach(transaction => {
                        if (category.type === 'income') {
                            totalIncome += parseFloat(transaction.amount);
                            categoryTotal += parseFloat(transaction.amount);
                        } else {
                            totalExpense += parseFloat(transaction.amount);
                            categoryTotal += parseFloat(transaction.amount);
                        }
                    });
                });
                
                category.total = categoryTotal;
            });
            
            document.getElementById('totalIncome').textContent = `SAR ${totalIncome.toFixed(2)}`;
            document.getElementById('totalExpense').textContent = `SAR ${totalExpense.toFixed(2)}`;
            document.getElementById('totalBalance').textContent = `SAR ${(totalIncome - totalExpense).toFixed(2)}`;
            
            // Render categories
            const categoriesList = document.getElementById('categoriesList');
            categoriesList.innerHTML = '';
            
            if (categories.length === 0) {
                categoriesList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>‡¶ï‡ßã‡¶® ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡ßá‡¶á‡•§ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ + ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ü‡¶ø‡¶™‡ßÅ‡¶®‡•§</p>
                    </div>
                `;
                return;
            }
            
            categories.forEach(category => {
                const categoryCard = document.createElement('div');
                categoryCard.className = 'glass-card rounded-xl p-4 shadow-lg cursor-pointer hover:bg-blue-50 transition';
                categoryCard.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-medium">${category.name}</h3>
                            <p class="text-gray-600">${category.type === 'income' ? '‡¶Ü‡ßü' : '‡¶ñ‡¶∞‡¶ö'}: SAR ${category.total ? category.total.toFixed(2) : '0'}</p>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </div>
                `;
                
                categoryCard.addEventListener('click', () => {
                    currentCategoryId = category.id;
                    showPage('subCategories');
                });
                
                categoriesList.appendChild(categoryCard);
            });
        }

        // Sub-Categories Page Rendering
        function renderSubCategoriesPage() {
            const categories = getData(STORAGE_KEYS.CATEGORIES);
            const currentCategory = categories.find(c => c.id === currentCategoryId);
            
            if (!currentCategory) {
                showPage('dashboard');
                return;
            }
            
            document.getElementById('subCategoryPageTitle').textContent = currentCategory.name;
            
            const subCategories = getData(STORAGE_KEYS.SUB_CATEGORIES)
                .filter(sc => sc.categoryId === currentCategoryId);
            
            const transactions = getData(STORAGE_KEYS.TRANSACTIONS);
            
            // Calculate totals
            let totalTransactions = 0;
            let totalAmount = 0;
            
            subCategories.forEach(subCategory => {
                const subTransactions = transactions.filter(t => t.subCategoryId === subCategory.id);
                totalTransactions += subTransactions.length;
                
                subTransactions.forEach(transaction => {
                    totalAmount += parseFloat(transaction.amount);
                });
            });
            
            document.getElementById('totalTransactions').textContent = totalTransactions;
            document.getElementById('totalAmount').textContent = `SAR ${totalAmount.toFixed(2)}`;
            
            // Render sub-categories
            const subCategoriesList = document.getElementById('subCategoriesList');
            subCategoriesList.innerHTML = '';
            
            if (subCategories.length === 0) {
                subCategoriesList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>‡¶ï‡ßã‡¶® ‡¶∏‡¶æ‡¶¨-‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡ßá‡¶á‡•§ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶∏‡¶æ‡¶¨-‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ + ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ü‡¶ø‡¶™‡ßÅ‡¶®‡•§</p>
                    </div>
                `;
                return;
            }
            
            subCategories.forEach(subCategory => {
                const subTransactions = transactions.filter(t => t.subCategoryId === subCategory.id);
                let subTotal = 0;
                subTransactions.forEach(t => subTotal += parseFloat(t.amount));
                
                const subCategoryCard = document.createElement('div');
                subCategoryCard.className = 'glass-card rounded-xl p-4 shadow-lg cursor-pointer hover:bg-blue-50 transition';
                subCategoryCard.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-medium">${subCategory.name}</h3>
                            <p class="text-gray-600">‡¶Æ‡ßã‡¶ü: SAR ${subTotal.toFixed(2)} (${subTransactions.length} ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®)</p>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </div>
                `;
                
                subCategoryCard.addEventListener('click', () => {
                    currentSubCategoryId = subCategory.id;
                    showPage('transactions');
                });
                
                subCategoriesList.appendChild(subCategoryCard);
            });
        }

        // Transactions Page Rendering
        function renderTransactionsPage() {
            const subCategories = getData(STORAGE_KEYS.SUB_CATEGORIES);
            const currentSubCategory = subCategories.find(sc => sc.id === currentSubCategoryId);
            
            if (!currentSubCategory) {
                showPage('subCategories');
                return;
            }
            
            document.getElementById('transactionPageTitle').textContent = currentSubCategory.name;
            
            const transactions = getData(STORAGE_KEYS.TRANSACTIONS)
                .filter(t => t.subCategoryId === currentSubCategoryId);
            
            // Calculate totals
            let totalAmount = 0;
            transactions.forEach(t => totalAmount += parseFloat(t.amount));
            
            document.getElementById('transactionsCount').textContent = transactions.length;
            document.getElementById('transactionsAmount').textContent = `SAR ${totalAmount.toFixed(2)}`;
            
            // Render transactions
            const transactionsList = document.getElementById('transactionsList');
            transactionsList.innerHTML = '';
            
            if (transactions.length === 0) {
                transactionsList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>‡¶ï‡ßã‡¶® ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶®‡ßá‡¶á‡•§ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ + ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ü‡¶ø‡¶™‡ßÅ‡¶®‡•§</p>
                    </div>
                `;
                return;
            }
            
            // Sort transactions by date (newest first)
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            transactions.forEach(transaction => {
                const transactionCard = document.createElement('div');
                transactionCard.className = 'glass-card rounded-xl p-4 shadow-lg';
                transactionCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-lg font-medium">SAR ${parseFloat(transaction.amount).toFixed(2)}</p>
                            <p class="text-gray-600">${formatDate(transaction.date)}</p>
                            <p class="text-gray-600 mt-1">${transaction.description || '‡¶ï‡ßã‡¶® ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶®‡ßá‡¶á'}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="edit-transaction text-blue-600" data-id="${transaction.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button class="delete-transaction text-red-600" data-id="${transaction.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                transactionsList.appendChild(transactionCard);
            });
            
            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.edit-transaction').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const transactionId = e.currentTarget.getAttribute('data-id');
                    openEditTransactionModal(transactionId);
                });
            });
            
            document.querySelectorAll('.delete-transaction').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const transactionId = e.currentTarget.getAttribute('data-id');
                    showConfirmModal(
                        '‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®',
                        '‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶á ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?',
                        () => deleteTransaction(transactionId)
                    );
                });
            });
        }

        // Format date to display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('bn-BD');
        }

        // Floating Action Button
        const fab = document.getElementById('fab');
        
        fab.addEventListener('click', () => {
            if (currentPage === 'dashboard') {
                openAddCategoryModal();
            } else if (currentPage === 'subCategories') {
                openAddSubCategoryModal();
            } else if (currentPage === 'transactions') {
                openAddTransactionModal();
            }
        });

        // Modals
        // Add Category Modal
        const addCategoryModal = document.getElementById('addCategoryModal');
        const addCategoryForm = document.getElementById('addCategoryForm');
        const cancelCategory = document.getElementById('cancelCategory');

        function openAddCategoryModal() {
            addCategoryModal.classList.remove('hidden');
        }

        function closeAddCategoryModal() {
            addCategoryModal.classList.add('hidden');
            addCategoryForm.reset();
        }

        cancelCategory.addEventListener('click', closeAddCategoryModal);

        addCategoryForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const name = document.getElementById('categoryName').value;
            const type = document.getElementById('categoryType').value;
            
            const categories = getData(STORAGE_KEYS.CATEGORIES);
            categories.push({
                id: generateId(),
                name,
                type
            });
            
            saveData(STORAGE_KEYS.CATEGORIES, categories);
            closeAddCategoryModal();
            renderDashboard();
        });

        // Add Sub-Category Modal
        const addSubCategoryModal = document.getElementById('addSubCategoryModal');
        const addSubCategoryForm = document.getElementById('addSubCategoryForm');
        const cancelSubCategory = document.getElementById('cancelSubCategory');

        function openAddSubCategoryModal() {
            addSubCategoryModal.classList.remove('hidden');
        }

        function closeAddSubCategoryModal() {
            addSubCategoryModal.classList.add('hidden');
            addSubCategoryForm.reset();
        }

        cancelSubCategory.addEventListener('click', closeAddSubCategoryModal);

        addSubCategoryForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const name = document.getElementById('subCategoryName').value;
            
            const subCategories = getData(STORAGE_KEYS.SUB_CATEGORIES);
            subCategories.push({
                id: generateId(),
                categoryId: currentCategoryId,
                name
            });
            
            saveData(STORAGE_KEYS.SUB_CATEGORIES, subCategories);
            closeAddSubCategoryModal();
            renderSubCategoriesPage();
        });

        // Add Transaction Modal
        const addTransactionModal = document.getElementById('addTransactionModal');
        const addTransactionForm = document.getElementById('addTransactionForm');
        const cancelTransaction = document.getElementById('cancelTransaction');

        function openAddTransactionModal() {
            // Set today's date as default
            document.getElementById('transactionDate').valueAsDate = new Date();
            addTransactionModal.classList.remove('hidden');
        }

        function closeAddTransactionModal() {
            addTransactionModal.classList.add('hidden');
            addTransactionForm.reset();
        }

        cancelTransaction.addEventListener('click', closeAddTransactionModal);

        addTransactionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const amount = document.getElementById('transactionAmount').value;
            const date = document.getElementById('transactionDate').value;
            const description = document.getElementById('transactionDescription').value;
            
            const transactions = getData(STORAGE_KEYS.TRANSACTIONS);
            transactions.push({
                id: generateId(),
                subCategoryId: currentSubCategoryId,
                amount,
                date,
                description
            });
            
            saveData(STORAGE_KEYS.TRANSACTIONS, transactions);
            closeAddTransactionModal();
            renderTransactionsPage();
        });

        // Edit Transaction Modal
        const editTransactionModal = document.getElementById('editTransactionModal');
        const editTransactionForm = document.getElementById('editTransactionForm');
        const cancelEditTransaction = document.getElementById('cancelEditTransaction');

        function openEditTransactionModal(transactionId) {
            const transactions = getData(STORAGE_KEYS.TRANSACTIONS);
            const transaction = transactions.find(t => t.id === transactionId);
            
            if (transaction) {
                document.getElementById('editTransactionId').value = transaction.id;
                document.getElementById('editTransactionAmount').value = transaction.amount;
                document.getElementById('editTransactionDate').value = transaction.date;
                document.getElementById('editTransactionDescription').value = transaction.description || '';
                
                editTransactionModal.classList.remove('hidden');
            }
        }

        function closeEditTransactionModal() {
            editTransactionModal.classList.add('hidden');
            editTransactionForm.reset();
        }

        cancelEditTransaction.addEventListener('click', closeEditTransactionModal);

        editTransactionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const id = document.getElementById('editTransactionId').value;
            const amount = document.getElementById('editTransactionAmount').value;
            const date = document.getElementById('editTransactionDate').value;
            const description = document.getElementById('editTransactionDescription').value;
            
            const transactions = getData(STORAGE_KEYS.TRANSACTIONS);
            const transactionIndex = transactions.findIndex(t => t.id === id);
            
            if (transactionIndex !== -1) {
                transactions[transactionIndex] = {
                    id,
                    subCategoryId: currentSubCategoryId,
                    amount,
                    date,
                    description
                };
                
                saveData(STORAGE_KEYS.TRANSACTIONS, transactions);
                closeEditTransactionModal();
                renderTransactionsPage();
            }
        });

        // Delete Transaction
        function deleteTransaction(transactionId) {
            const transactions = getData(STORAGE_KEYS.TRANSACTIONS);
            const updatedTransactions = transactions.filter(t => t.id !== transactionId);
            
            saveData(STORAGE_KEYS.TRANSACTIONS, updatedTransactions);
            renderTransactionsPage();
            closeConfirmModal();
        }

        // Confirmation Modal
        const confirmModal = document.getElementById('confirmModal');
        const confirmTitle = document.getElementById('confirmTitle');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmOk = document.getElementById('confirmOk');

        let confirmCallback = null;

        function showConfirmModal(title, message, callback) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmCallback = callback;
            confirmModal.classList.remove('hidden');
        }

        function closeConfirmModal() {
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        }

        confirmCancel.addEventListener('click', closeConfirmModal);
        confirmOk.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
        });

        // Info Modal
        const infoModal = document.getElementById('infoModal');
        const infoBtn = document.getElementById('infoBtn');
        const closeInfoModal = document.getElementById('closeInfoModal');
        const helpLineBtn = document.getElementById('helpLineBtn');
        const shareAppBtn = document.getElementById('shareAppBtn');

        infoBtn.addEventListener('click', () => {
            infoModal.classList.remove('hidden');
        });

        closeInfoModal.addEventListener('click', () => {
            infoModal.classList.add('hidden');
        });

        helpLineBtn.addEventListener('click', () => {
            window.open('https://zunaidhosse.github.io/My-contact/', '_blank');
            infoModal.classList.add('hidden');
        });

        shareAppBtn.addEventListener('click', () => {
            infoModal.classList.add('hidden');
            openQrModal();
        });

        // QR Code Modal
        const qrModal = document.getElementById('qrModal');
        const qrCodeContainer = document.getElementById('qrCodeContainer');
        const closeQrModal = document.getElementById('closeQrModal');

        function openQrModal() {
            if (navigator.onLine) {
                qrCodeContainer.innerHTML = `
                    <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://zunaidhosse.github.io/shop_hisab_offline/&size=200x200" 
                         alt="QR Code" class="mx-auto">
                `;
            } else {
                qrCodeContainer.innerHTML = `
                    <div class="bg-yellow-100 p-4 rounded-lg">
                        <p>QR ‡¶ï‡ßã‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡•§</p>
                    </div>
                `;
            }
            
            qrModal.classList.remove('hidden');
        }

        closeQrModal.addEventListener('click', () => {
            qrModal.classList.add('hidden');
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Set today's date as default for transaction forms
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;
            document.getElementById('editTransactionDate').value = today;
            
            // Render the dashboard
            renderDashboard();
        });
    </script>
</body>
</html>